<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>Titel</title>
<!-- AR.js by @jerome_etienne - github: https://github.com/jeromeetienne/ar.js - info: https://medium.com/arjs/augmented-reality-in-10-lines-of-html-4e193ea9fdbf -->
<script src="https://aframe.io/releases/0.9.2/aframe.min.js"></script>
<!-- <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.6.0/aframe/build/aframe-ar.js"></script> -->
<script src="https://cdn.jsdelivr.net/npm/ar.js@2.0.8/aframe/build/aframe-ar.min.js"></script>
<!-- <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.0.1/dist/aframe-extras.min.js"></script>-->
<script src="aframe-look-at-billboard-component.min.js"></script>
<script src="mline.js"></script>
 <script>
function getUrlParameter(name) {
    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    var results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
};
 </script>
<script>
/**
 * This is from https://stackoverflow.com/questions/494143/creating-a-new-dom-element-from-an-html-string-using-built-in-dom-methods-or-pro
 * @author Mark Amery https://stackoverflow.com/users/1709587/mark-amery
 * @param {String} HTML representing a single element
 * @return {Element}
 */
function htmlToElement(html) {
    var template = document.createElement('template');
    html = html.trim(); // Never return a text node of whitespace as the result
    template.innerHTML = html;
    return template.content.firstChild;
}

/**
 * @param {String} HTML representing any number of sibling elements
 * @return {NodeList} 
 */
function htmlToElements(html) {
    var template = document.createElement('template');
    template.innerHTML = html;
    return template.content.childNodes;
}
</script>

<script>
var chargpos=new Array();
var charges=new Array();
var charges;
var flsrc=new Array();
var distSquared=new Array();
var numMarkers,myCharge;
var rl=new THREE.Vector3;
var worker=new THREE.Vector3();
var step=.1;
var tickCount=0;
var totalforce=new THREE.Vector3();
var markers=new Array();
var path="";
var startl,endl;
var fieldlines;
var thickness=1;

function minimum2(arr){
  var i=0;
  var m;
  while(m===undefined&&i<arr.length){
    m=arr[i];
    i++;
  }
  if(m===undefined)return m;
  for(;i<arr.length;i++){
    if(!(Math.min(m,arr[i])===NaN)){m=Math.min(m,arr[i]);}
  }
  return m;
}


function mkfields(){
    for (var u=0; u<flsrc.length; u++) {
      worker.copy(flsrc[u]);
      worker.add(chargpos[Math.floor(u/12)]); //offset by charge
 
      for (var n=0; n<chargpos.length; n++) {
        distSquared[n]=worker.distanceToSquared(chargpos[n]);
      }
      myCharge=charges[distSquared.indexOf(Math.min.apply(null, distSquared))];
      if(myCharge!=0){//marker is visible
      path=""+worker.x.toFixed(4)+ " "+worker.y.toFixed(4)+" "+worker.z.toFixed(4);
       for (var i=0; (i<200&&minimum2(distSquared)>0.08); i++) {//&&minimum2(distSquared)>0.24
         totalforce.set(0, 0, 0);
          for (var k=0; k<chargpos.length; k++) {
            distSquared[k]=worker.distanceToSquared(chargpos[k]);
            F=1/distSquared[k];
            rl.copy(worker);
            rl.sub(chargpos[k]);
            rl.setLength(F);
            rl.multiplyScalar(charges[k]*myCharge);
            totalforce.add(rl);
          }
          totalforce.setLength(step);
          worker.add(totalforce);
          if (i%1==0&&charges[Math.floor(u/12)]!=0) {
             path=path+", "+worker.x.toFixed(4)+ " "+worker.y.toFixed(4)+" "+worker.z.toFixed(4);
          }
          for (var j=0; j<chargpos.length; j++) {
            distSquared[j]=worker.distanceToSquared(chargpos[j]);
          }
        }
       document.getElementById('fieldline').setAttribute("mline__"+u,"path:"+path+";color: yellow;visible:true");
 			   
      }else{
        document.getElementById('fieldline').setAttribute("mline__"+u,{visible:false,});
      }
    }
}

AFRAME.registerComponent('sources',{
  init: function(){
    var linew=getUrlParameter("lw");
    if(1*linew)thickness=linew;
    markers=this.el.children;
    var nocol=getUrlParameter("bw");
    if(1*nocol){
       for(var m of markers){
          m.children[0].setAttribute("material","color","grey");
       }
    }
    numMarkers=this.el.children.length;
    distSquared=new Array(numMarkers);

     for(var marker of markers){
       charges.push(0);
       chargpos.push(new THREE.Vector3(0,0,0));

       flsrc.push(new THREE.Vector3( 0.57735026918962576451, -1, -1.5115226281523414610));
       flsrc.push(new THREE.Vector3(-1.1547005383792515290, 0, -1.5115226281523414610));
       flsrc.push(new THREE.Vector3( 0.57735026918962576451, 1, -1.5115226281523414610));

       flsrc.push(new THREE.Vector3(-0.93417235896271569645, -1.6180339887498948482, -0.35682208977308993194));
       flsrc.push(new THREE.Vector3(1.8683447179254313929, 0, -0.35682208977308993194));
       flsrc.push(new THREE.Vector3(-0.93417235896271569645, 1.6180339887498948482, -0.35682208977308993194));

       flsrc.push(new THREE.Vector3( 0.93417235896271569645, -1.6180339887498948482, 0.35682208977308993194));
       flsrc.push(new THREE.Vector3(-1.8683447179254313929, 0, 0.35682208977308993194));
       flsrc.push(new THREE.Vector3(0.93417235896271569645, 1.6180339887498948482, 0.35682208977308993194));

       flsrc.push(new THREE.Vector3(-0.57735026918962576451, -1, 1.5115226281523414610));
       flsrc.push(new THREE.Vector3(1.1547005383792515290, 0, 1.5115226281523414610));
       flsrc.push(new THREE.Vector3(-0.57735026918962576451, 1, 1.5115226281523414610));
    }
    for(var v of flsrc){
      v.setLength(0.3);
    }
    
  },
  
  tick: function(){
    tickCount++;
    tickCount=tickCount%2;
    if(tickCount==0)return;
    var i=0;
    for(var i=0;i<this.el.children.length;i++){
       if(this.el.children[i].getAttribute("visible")==true){
         chargpos[i].copy(this.el.children[i].object3D.getWorldPosition(new THREE.Vector3()));
         charges[i]=(this.el.children[i].getAttribute("charge"));
       }else{
         charges[i]=0;
         chargpos[i].set(0,0,0);
       }
    }
    mkfields();
  }
});
  var potDist=0;
  var millikan,poti;
  var milliLoc=new THREE.Vector3();
  var potiLoc=new THREE.Vector3();
  var disp;
AFRAME.registerComponent('millikan',{
  init: function(){
    poti=document.getElementById("potentiometer").object3D;
    millikan=document.getElementById("millikan").object3D;
    disp=document.getElementById("disp");
  },
  tick: function(){
    if(millikan.visible==true&&poti.visible==true){
      var potVec=document.getElementById("millikan").object3D.getWorldPosition(milliLoc);
      milliLoc=potVec;
      potVec.sub(poti.getWorldPosition(potiLoc));
      potDist=potVec.length();
      potDist-=1.7;
      potDist/=2;
      potDist*=6;
      potDist=Math.min(potDist,6);
      potDist=Math.max(potDist,0);
      disp.setAttribute("value",Math.floor(100*potDist).pad(3)+"V");
    }else{
      
    }
  }

});
Number.prototype.pad = function(size) {
    var s = String(this);
    while (s.length < (size || 2)) {s = "0" + s;}
    return s;
}
</script>

  </head>
<body style='margin : 0px; overflow: hidden;'>
	<a-scene stats embedded renderer="logarithmicDepthBuffer: false; colorManagement: true; sortObjects: true;" arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3_HAMMING63"><!-- 4x4_BCH_13_5_5 -->
		<a-entity millikan id="markers">
	 	 <a-marker smooth="true" id="millikan" charge=1 type='barcode' value='0'>
	 	   <a-cylinder radius=0.2 height=1.92 position="0 .96 0" material="color:silver;metalness:0.5;"></a-cylinder>
	 	   <a-cylinder radius=1 height=0.1 position="0 1.95 0" material="color:silver;metalness:0.5;"></a-cylinder>
	 	   <a-cylinder radius=1 height=0.1 position="0 3.05 0" material="color:silver;metalness:0.5;"></a-cylinder>
	 	 </a-marker>
	 	
	 	 <a-marker smooth="true" id="potentiometer" charge=-1 type='barcode' value='1'>
	 	   <a-box id=knob depth=1 height=0.33 width=1 position="0 .165 0" rotation="0 90 0" material="color:grey;opacity:1;"></a-box>
	 	   <a-box depth=0.4 width=0.8 height=0.02 color="#202020" rotation="0 0 0" position="-0.1 0.35 0"></a-box>
	 	   <a-text id="disp" value="000V" position="-0.5 0.37 0" scale="1.5 1.5 1.5" rotation="-90 0 0" color="red" ></a-text>
	 	   
	 	   
 	   	</a-marker>
		</a-entity>
		<a-entity id="fieldline" mline="label:'gt';path: -200 -0.8 -10,-200 0.8 -5,-200 0.8 -5;color:red;opacity:1;visible:false;"></a-entity>
		<a-entity camera id="cam"></a-entity>
		<a-entity light="type: ambient; color: #DDD"></a-entity>
		<a-entity light="type: directional; color: #DFD; intensity: 0.8" position="-0.5 1 1"></a-entity>
	</a-scene>
</body>
</html>
