<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Titel</title>
<!-- AR.js by @jerome_etienne - github: https://github.com/jeromeetienne/ar.js - info: https://medium.com/arjs/augmented-reality-in-10-lines-of-html-4e193ea9fdbf -->
<script src="https://aframe.io/releases/0.8.0/aframe.min.js"></script>
<script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.6.0/aframe/build/aframe-ar.js"></script>
<script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.0.1/dist/aframe-extras.min.js"></script>
<script src="https://rawgit.com/andreasplesch/aframe-meshline-component/master/dist/aframe-meshline-component.min.js"></script>
<script>
/**
 * This is from https://stackoverflow.com/questions/494143/creating-a-new-dom-element-from-an-html-string-using-built-in-dom-methods-or-pro
 * @author Mark Amery https://stackoverflow.com/users/1709587/mark-amery
 * @param {String} HTML representing a single element
 * @return {Element}
 */
function htmlToElement(html) {
    var template = document.createElement('template');
    html = html.trim(); // Never return a text node of whitespace as the result
    template.innerHTML = html;
    return template.content.firstChild;
}

/**
 * @param {String} HTML representing any number of sibling elements
 * @return {NodeList} 
 */
function htmlToElements(html) {
    var template = document.createElement('template');
    template.innerHTML = html;
    return template.content.childNodes;
}
</script>

<script>
var chargpos=new Array();
var charges=new Array();
var charges;
var pos=new THREE.Vector3(0,0,0);
var scl=new THREE.Vector3(0,0,0);
var quat=new THREE.Quaternion();
var flsrc=new Array();
var distSquared=new Array();
var numMarkers,myCharge;
var rl=new THREE.Vector3;
var worker=new THREE.Vector3();
var step=.05;
var tickCount=0;
var totalforce=new THREE.Vector3();
var markers=new Array();
var path="";
var fieldlines;
function minimum(arr){
  var i=0;
  var m;
  while(m===undefined&&i<arr.length){
    m=arr[i];
  }
  if(m===undefined)return m;
  for(;i<arr.length;i++){
    if(!(Math.min(m,arr[i])===NaN)){m=Math.min(m,arr[i]);}
  }
  return m;
}
function mkfields(){
    for (var u=0; u<flsrc.length; u++) {
      worker.copy(flsrc[u]);
      worker.add(chargpos[Math.floor(u/12)]); //offset by charge

      for (var n=0; n<chargpos.length; n++) {
        distSquared[n]=worker.distanceToSquared(chargpos[n]);
      }
      myCharge=charges[distSquared.indexOf(Math.min.apply(null, distSquared))];
      if(myCharge!=0){//marker is visible
      path="lineWidth:1;path:"+worker.x+ " "+worker.y+" "+worker.z;
       for (var i=0; (i<200&&minimum(distSquared)>0.24); i++) {
         totalforce.set(0, 0, 0);
          for (var k=0; k<chargpos.length; k++) {
            distSquared[k]=worker.distanceToSquared(chargpos[k]);
            F=1/distSquared[k];
            rl.copy(worker);
            rl.sub(chargpos[k]);
            rl.setLength(F);
            rl.multiplyScalar(charges[k]*myCharge);
            totalforce.add(rl);
          }
          totalforce.setLength(step);
          worker.add(totalforce);
          if (i%5==0&&charges[Math.floor(u/12)]!=0) {
             path=path.concat(", "+worker.x+ " "+worker.y+" "+worker.z);
             
          }
          for (var j=0; j<chargpos.length; j++) {
            distSquared[j]=worker.distanceToSquared(chargpos[j]);
          }
        }
        fieldlines.children[u].setAttribute("meshline",path+";color:yellow;");
        fieldlines.children[u].setAttribute("visible",true);
      }else{
        fieldlines.children[u].setAttribute("visible","false");
      }
    }
}

AFRAME.registerComponent('sources',{
  init: function(){
    markers=this.el.children;
    numMarkers=this.el.children.length;
    distSquared=new Array(numMarkers);
    var tube=new Array('<a-entity meshline="lineWidth:1;path:0 0 0;color:yellow;"></a-tube>',);
    fieldlines=document.getElementById("fieldlines");
     for(var marker of markers){
       charges.push(0);
       chargpos.push(new THREE.Vector3(0,0,0));
       for(var s of tube){
          fieldlines.appendChild(htmlToElement(s));
          fieldlines.appendChild(htmlToElement(s));
          fieldlines.appendChild(htmlToElement(s));
          fieldlines.appendChild(htmlToElement(s));
          fieldlines.appendChild(htmlToElement(s));
          fieldlines.appendChild(htmlToElement(s));
          fieldlines.appendChild(htmlToElement(s));
          fieldlines.appendChild(htmlToElement(s));
          fieldlines.appendChild(htmlToElement(s));
          fieldlines.appendChild(htmlToElement(s));
          fieldlines.appendChild(htmlToElement(s));
          fieldlines.appendChild(htmlToElement(s));

       }
       flsrc.push(new THREE.Vector3( 0.57735026918962576451, -1, -1.5115226281523414610));
       flsrc.push(new THREE.Vector3(-1.1547005383792515290, 0, -1.5115226281523414610));
       flsrc.push(new THREE.Vector3( 0.57735026918962576451, 1, -1.5115226281523414610));

       flsrc.push(new THREE.Vector3(-0.93417235896271569645, -1.6180339887498948482, -0.35682208977308993194));
       flsrc.push(new THREE.Vector3(1.8683447179254313929, 0, -0.35682208977308993194));
       flsrc.push(new THREE.Vector3(-0.93417235896271569645, 1.6180339887498948482, -0.35682208977308993194));

       flsrc.push(new THREE.Vector3( 0.93417235896271569645, -1.6180339887498948482, 0.35682208977308993194));
       flsrc.push(new THREE.Vector3(-1.8683447179254313929, 0, 0.35682208977308993194));
       flsrc.push(new THREE.Vector3(0.93417235896271569645, 1.6180339887498948482, 0.35682208977308993194));

       flsrc.push(new THREE.Vector3(-0.57735026918962576451, -1, 1.5115226281523414610));
       flsrc.push(new THREE.Vector3(1.1547005383792515290, 0, 1.5115226281523414610));
       flsrc.push(new THREE.Vector3(-0.57735026918962576451, 1, 1.5115226281523414610));
    }
    for(var v of flsrc){
      v.setLength(0.5);
    }
    
  },
  
  tick: function(){
    tickCount++;
    tickCount=tickCount%5;
    if(tickCount==0)return;
    var i=0;
    for(var i=0;i<this.el.children.length;i++){
       if(this.el.children[i].getAttribute("visible")==true){
         this.el.children[i].object3D.matrixWorld.decompose( pos,quat,scl );
         chargpos[i].set(pos.x,pos.y,pos.z);
         charges[i]=(this.el.children[i].getAttribute("charge"));
       }else{
         charges[i]=0;
         chargpos[i].set(1e6,1e6,1e6);
       }
    }
    mkfields();
  }
})
</script>

  </head>
<body style='margin : 0px; overflow: hidden;'>
	<a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3_HAMMING63;'>
		<a-entity sources id="markers">
	 	 <a-marker id="myMarker" charge=1 type='barcode' value='0'><a-sphere radius=0.5 position="0 0 0" material="color:red;opacity:1;"></a-sphere></a-marker>
	 	 <a-marker id="myMarker" charge=-1 type='barcode' value='1'><a-sphere radius=0.5 position="0 0 0" material="color:blue;opacity:1;"></a-sphere></a-marker>
	 	 <a-marker id="myMarker" charge=1 type='barcode' value='2'><a-sphere radius=0.5 position="0 0 0" material="color:red;opacity:1;"></a-sphere></a-marker>
	 	 <a-marker id="myMarker" charge=-1 type='barcode' value='3'><a-sphere radius=0.5 position="0 0 0" material="color:blue;opacity:1;"></a-sphere></a-marker>
	 	 <a-marker id="myMarker" charge=1 type='barcode' value='4'><a-sphere radius=0.5 position="0 0 0" material="color:red;opacity:1;"></a-sphere></a-marker>
	 	 <a-marker id="myMarker" charge=-1 type='barcode' value='5'><a-sphere radius=0.5 position="0 0 0" material="color:blue;opacity:1;"></a-sphere></a-marker>
	 	 <a-marker id="myMarker" charge=1 type='barcode' value='6'><a-sphere radius=0.5 position="0 0 0" material="color:red;opacity:1;"></a-sphere></a-marker>
	 	 <a-marker id="myMarker" charge=-1 type='barcode' value='7'><a-sphere radius=0.5 position="0 0 0" material="color:blue;opacity:1;"></a-sphere></a-marker>
		</a-entity>
		<a-entity id="fieldlines"></a-entity>
		<a-entity camera></a-entity>
	</a-scene>
</body>
</html>
